"use strict";(()=>{var e={};e.id=426,e.ids=[426],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},20721:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>v,staticGenerationAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{GET:()=>d,OPTIONS:()=>p,dynamic:()=>c});var o=r(49303),n=r(88716),i=r(60670),a=r(87070),u=r(85662);let c="force-dynamic",l=new Map;async function d(e,{params:t}){let r={"Cache-Control":"public, max-age=10","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type"};try{let{widgetId:s}=t;if(!/^[a-zA-Z0-9_-]{12}$/.test(s))return a.NextResponse.json({success:!1,error:"Invalid widget ID format"},{status:400,headers:r});if(!function(e){let t=Date.now(),r=l.get(e);return!r||t>r.resetAt?(l.set(e,{count:1,resetAt:t+6e4}),!0):!(r.count>=100)&&(r.count++,!0)}(s))return a.NextResponse.json({success:!1,error:"Too many requests"},{status:429,headers:r});let o=e.nextUrl.searchParams.get("limit"),n=Math.min(parseInt(o||"50",10),100),i=(0,u.m)(),{data:c,error:d}=await i.from("users").select("id, paid").eq("widget_id",s).maybeSingle();if(d)return console.error("[Visitors] Database error:",d),a.NextResponse.json({success:!1,error:"Database error"},{status:500,headers:r});if(!c)return a.NextResponse.json({success:!1,error:"Widget ID not found"},{status:404,headers:r});if(!c.paid)return a.NextResponse.json({success:!1,error:"Payment required"},{status:402,headers:r});let{data:p,error:g}=await i.from("visitors").select("id, latitude, longitude, city, country, created_at").eq("user_id",c.id).order("created_at",{ascending:!1}).limit(n);if(g)return console.error("[Visitors] Error fetching visitors:",g),a.NextResponse.json({success:!1,error:"Failed to fetch visitors"},{status:500,headers:r});let m=new Date,w=new Date(m.getTime()-3e5),v=new Date(m.getFullYear(),m.getMonth(),m.getDate()),x=(p||[]).map(e=>{let t=new Date(e.created_at);return{id:e.id,lat:parseFloat(e.latitude.toString()),lng:parseFloat(e.longitude.toString()),city:e.city,country:e.country,timestamp:e.created_at,isRecent:t>w}}),A=(p||[]).filter(e=>new Date(e.created_at)>=v).length,f=(p||[]).filter(e=>new Date(e.created_at)>w).length;return a.NextResponse.json({success:!0,data:{visitors:x,totalToday:A,activeNow:f}},{headers:r})}catch(e){return console.error("[Visitors] Error:",e),a.NextResponse.json({success:!1,error:"Internal server error"},{status:500,headers:r})}}async function p(e){return new a.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}let g=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/visitors/[widgetId]/route",pathname:"/api/visitors/[widgetId]",filename:"route",bundlePath:"app/api/visitors/[widgetId]/route"},resolvedPagePath:"/workspace/app/api/visitors/[widgetId]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:w,serverHooks:v}=g,x="/api/visitors/[widgetId]/route";function A(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:w})}},85662:(e,t,r)=>{r.d(t,{m:()=>o});var s=r(94738);function o(){let e=process.env.NEXT_PUBLIC_SUPABASE_URL,t=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!e||!t)throw Error("Missing Supabase environment variables");return(0,s.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,37,70],()=>r(20721));module.exports=s})();