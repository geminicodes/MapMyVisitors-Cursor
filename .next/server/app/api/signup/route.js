"use strict";(()=>{var e={};e.id=538,e.ids=[538],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},31823:(e,r,t)=>{let s,o;t.r(r),t.d(r,{originalPathname:()=>E,patchFetch:()=>_,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>x,staticGenerationAsyncStorage:()=>w});var a={};t.r(a),t.d(a,{POST:()=>m});var n=t(49303),i=t(88716),u=t(60670),c=t(87070),p=t(6005),l=t(85662);let d=new Map;async function g(e){for(let r=0;r<3;r++){let r=function(e=21){var r;r=e|=0,!s||s.length<r?(s=Buffer.allocUnsafe(128*r),p.webcrypto.getRandomValues(s),o=0):o+r>s.length&&(p.webcrypto.getRandomValues(s),o=0),o+=r;let t="";for(let r=o-e;r<o;r++)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&s[r]];return t}(12),{data:t,error:a}=await e.from("users").select("widget_id").eq("widget_id",r).maybeSingle();if(a)throw console.error("[Signup] Error checking widget ID uniqueness:",a),a;if(!t)return r}throw Error("Failed to generate unique widget ID")}async function m(e){try{let r=e.headers.get("x-forwarded-for")?.split(",")[0]||e.headers.get("x-real-ip")||"unknown";if(!function(e){let r=Date.now(),t=d.get(e);return!t||r>t.resetAt?(d.set(e,{count:1,resetAt:r+36e5}),!0):!(t.count>=5)&&(t.count++,!0)}(r))return c.NextResponse.json({success:!1,error:"Too many signup attempts. Please try again later."},{status:429});let{email:t}=await e.json();if(!t||"string"!=typeof t)return c.NextResponse.json({success:!1,error:"Email is required"},{status:400});let s=t.toLowerCase().trim();if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s))return c.NextResponse.json({success:!1,error:"Invalid email format"},{status:400});let o=(0,l.m)(),{data:a}=await o.from("users").select("email").eq("email",s).maybeSingle();if(a)return c.NextResponse.json({success:!1,error:"Email already registered"},{status:409});let n=await g(o),{data:i,error:u}=await o.from("users").insert({email:s,widget_id:n,paid:!1}).select("id, email, widget_id").single();if(u)return console.error("[Signup] Failed to create user:",u),c.NextResponse.json({success:!1,error:"Failed to create user"},{status:500});let p=process.env.NEXT_PUBLIC_LEMONSQUEEZY_CHECKOUT_URL||"https://example.com/checkout",m=new URL(p);return m.searchParams.set("checkout[email]",s),m.searchParams.set("checkout[custom][user_id]",i.id),m.searchParams.set("checkout[custom][widget_id]",n),console.log("[Signup] User created:",{userId:i.id,widgetId:n,email:s}),c.NextResponse.json({success:!0,data:{userId:i.id,widgetId:n,checkoutUrl:m.toString()}})}catch(e){return console.error("[Signup] Error:",e),c.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/signup/route",pathname:"/api/signup",filename:"route",bundlePath:"app/api/signup/route"},resolvedPagePath:"/workspace/app/api/signup/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:w,serverHooks:x}=f,E="/api/signup/route";function _(){return(0,u.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:w})}},85662:(e,r,t)=>{t.d(r,{m:()=>o});var s=t(94738);function o(){let e=process.env.NEXT_PUBLIC_SUPABASE_URL,r=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!e||!r)throw Error("Missing Supabase environment variables");return(0,s.eI)(e,r,{auth:{persistSession:!1,autoRefreshToken:!1}})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,37,70],()=>t(31823));module.exports=s})();