"use strict";(()=>{var e={};e.id=108,e.ids=[108],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},98063:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>A,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>w});var o={};t.r(o),t.d(o,{POST:()=>c,dynamic:()=>h,revalidate:()=>m,runtime:()=>p});var n=t(49303),s=t(88716),a=t(60670),i=t(84770),u=t.n(i),d=t(94738);function l(e){return"string"==typeof e&&e.trim().length>0?e:null}async function c(e){var r;let t,o;let n=new Date().toISOString(),s="";try{s=await e.text()}catch(e){return console.error("[Webhook] ❌ Failed to read raw body",{timestamp:n,action:"MANUAL_FIX",error:e instanceof Error?e.message:"unknown_error"}),new Response("OK",{status:200})}let a=e.headers.get("x-signature");if(!a)return console.error("[Webhook] \uD83D\uDEA8 Missing signature header",{timestamp:n,hasSignature:!1}),new Response("Unauthorized",{status:401});let i=process.env.LEMONSQUEEZY_WEBHOOK_SECRET;if(!i)return console.error("[Webhook] \uD83D\uDEA8 Webhook secret not configured",{timestamp:n,hasSignature:!0,action:"MANUAL_FIX"}),new Response("Unauthorized",{status:401});if(!function(e,r){try{let t=Buffer.from(e,"hex"),o=Buffer.from(r,"hex");if(0===t.length||0===o.length||t.toString("hex")!==e.toLowerCase()||o.toString("hex")!==r.toLowerCase()||t.length!==o.length)return!1;return u().timingSafeEqual(t,o)}catch{return!1}}(function(e){let r=e.trim(),t=r.split("=");return(t.length>1?t[t.length-1]:r).trim()}(a),(r=s,u().createHmac("sha256",i).update(r).digest("hex"))))return console.error("[Webhook] \uD83D\uDEA8 Invalid signature",{timestamp:n,hasSignature:!0}),new Response("Unauthorized",{status:401});try{let e=JSON.parse(s);t="object"!=typeof e||null===e||Array.isArray(e)?{}:e}catch(e){return console.error("[Webhook] ❌ Invalid JSON payload",{timestamp:n,action:"MANUAL_FIX",error:e instanceof Error?e.message:"unknown_error"}),new Response("OK",{status:200})}let c=l(t.meta?.event_name);if("order_created"!==c)return console.log("[Webhook] ℹ️ Ignored event",{timestamp:n,eventName:c??"unknown"}),new Response("OK",{status:200});let p=l(t.meta?.custom_data?.user_id),h=l(t.meta?.custom_data?.widget_id),m=l(t.data?.id),g=l(t.data?.attributes?.status),f=l(t.data?.attributes?.user_email),w="number"==typeof t.data?.attributes?.total?t.data.attributes.total:null,_=l(t.data?.attributes?.currency);if(!p||!h||!m||!g)return console.error("[Webhook] ❌ Missing required fields",{timestamp:n,action:"MANUAL_FIX",hasUserId:!!p,hasWidgetId:!!h,hasOrderId:!!m,hasStatus:!!g}),new Response("OK",{status:200});if("paid"!==g)return console.log("[Webhook] ℹ️ Ignored non-paid order",{timestamp:n,userId:p,widgetId:h,orderId:m,status:g}),new Response("OK",{status:200});try{o=function(){let e=process.env.NEXT_PUBLIC_SUPABASE_URL,r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!r)throw Error("Missing Supabase env vars (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY)");return(0,d.eI)(e,r,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}()}catch(e){return console.error("[Webhook] ❌ Supabase service client misconfigured",{timestamp:n,action:"MANUAL_FIX",error:e instanceof Error?e.message:"unknown_error"}),new Response("OK",{status:200})}try{let{data:e,error:r}=await o.from("users").select("id, paid, lemonsqueezy_order_id, email, widget_id").eq("id",p).maybeSingle();if(r)return console.error("[Webhook] ❌ DB read failed",{timestamp:n,userId:p,orderId:m,action:"MANUAL_FIX",error:r.message}),new Response("OK",{status:200});if(!e)return console.warn("[Webhook] ⚠️ User not found",{timestamp:n,userId:p,orderId:m,email:f,widgetId:h}),new Response("OK",{status:200});let t=!0===e.paid,s=l(e.lemonsqueezy_order_id);t&&(s&&s!==m?console.warn("[Webhook] ⚠️ User already paid with different order id",{timestamp:n,userId:p,orderId:m,existingOrderId:s,action:"MANUAL_REVIEW"}):console.log("[Webhook] ℹ️ Already paid (idempotent)",{timestamp:n,userId:p,orderId:m}));let a=l(e.widget_id);a&&a!==h&&console.warn("[Webhook] ⚠️ Widget mismatch",{timestamp:n,userId:p,orderId:m,widgetId:h,dbWidgetId:a,action:"MANUAL_REVIEW"});let i=l(e.email);f&&i&&f.toLowerCase()!==i.toLowerCase()&&console.warn("[Webhook] ⚠️ Email mismatch",{timestamp:n,userId:p,orderId:m,email:f,dbEmail:i,action:"MANUAL_REVIEW"})}catch(e){return console.error("[Webhook] ❌ DB pre-check failed",{timestamp:n,userId:p,orderId:m,action:"MANUAL_FIX",error:e instanceof Error?e.message:"unknown_error"}),new Response("OK",{status:200})}try{let{data:e,error:r}=await o.from("users").update({paid:!0,lemonsqueezy_order_id:m}).eq("id",p).select("id");if(r)return console.error("[Webhook] ❌ DB update failed",{timestamp:n,userId:p,orderId:m,error:r.message,action:"MANUAL_FIX"}),new Response("OK",{status:200});let t=Array.isArray(e)?e.length:0;if(0===t)return console.warn("[Webhook] ⚠️ No rows updated (user not found?)",{timestamp:n,userId:p,orderId:m,action:"MANUAL_REVIEW"}),new Response("OK",{status:200});return console.log("[Webhook] ✅ Payment confirmed",{timestamp:n,userId:p,orderId:m,email:f,amount:w,currency:_}),new Response("OK",{status:200})}catch(e){return console.error("[Webhook] ❌ Unhandled exception during DB update",{timestamp:n,userId:p,orderId:m,action:"MANUAL_FIX",error:e instanceof Error?e.message:"unknown_error"}),new Response("OK",{status:200})}}let p="nodejs",h="force-dynamic",m=0,g=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhook/lemonsqueezy/route",pathname:"/api/webhook/lemonsqueezy",filename:"route",bundlePath:"app/api/webhook/lemonsqueezy/route"},resolvedPagePath:"/workspace/app/api/webhook/lemonsqueezy/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:w,serverHooks:_}=g,A="/api/webhook/lemonsqueezy/route";function b(){return(0,a.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:w})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[948,37],()=>t(98063));module.exports=o})();