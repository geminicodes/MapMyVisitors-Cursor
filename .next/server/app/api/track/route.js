"use strict";(()=>{var e={};e.id=234,e.ids=[234],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},80807:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>h,serverHooks:()=>v,staticGenerationAsyncStorage:()=>m});var o={};r.r(o),r.d(o,{OPTIONS:()=>w,POST:()=>y});var s=r(49303),n=r(88716),a=r(60670),i=r(87070),u=r(85662);let c=new Map;async function l(e){let t=c.get(e);if(t&&Date.now()<t.expiry)return t.data;if("127.0.0.1"===e||"::1"===e||e.startsWith("192.168.")||e.startsWith("10."))return{country:"Unknown",countryCode:"XX",city:null,latitude:0,longitude:0};try{let t=await fetch(`https://ipapi.co/${e}/json/`,{signal:AbortSignal.timeout(5e3)});if(!t.ok)throw Error("API error");let r=await t.json(),o={country:r.country_name||"Unknown",countryCode:r.country_code||"XX",city:r.city||null,latitude:r.latitude||0,longitude:r.longitude||0};return c.set(e,{data:o,expiry:Date.now()+36e5}),o}catch(t){return console.error("[GeoIP] Lookup failed:",{ip:e,error:t}),{country:"Unknown",countryCode:"XX",city:null,latitude:0,longitude:0}}}let p=new Map;async function d(e,t){let r=new Date,o=new Date(r.getFullYear(),r.getMonth(),1),{data:s,error:n}=await e.from("monthly_pageviews").select("pageview_count").eq("user_id",t).eq("month",o.toISOString().split("T")[0]).maybeSingle();if(n)throw console.error("[Track] Error checking monthly limit:",n),n;let a=s?.pageview_count||0;return{allowed:a<1e4,currentCount:a}}async function g(e,t){let r=new Date,o=new Date(r.getFullYear(),r.getMonth(),1).toISOString().split("T")[0],{data:s}=await e.from("monthly_pageviews").select("pageview_count").eq("user_id",t).eq("month",o).maybeSingle();if(s){let{error:r}=await e.from("monthly_pageviews").update({pageview_count:s.pageview_count+1}).eq("user_id",t).eq("month",o);r&&console.error("[Track] Error incrementing pageviews:",r)}else{let{error:r}=await e.from("monthly_pageviews").insert({user_id:t,month:o,pageview_count:1});r&&"23505"!==r.code&&console.error("[Track] Error creating pageview record:",r)}}async function w(e){return new i.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}async function y(e){let t={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"};try{let r=e.headers.get("x-forwarded-for")?.split(",")[0]||e.headers.get("x-real-ip")||"127.0.0.1";if(!function(e){let t=Date.now(),r=p.get(e);return!r||t>r.resetAt?(p.set(e,{count:1,resetAt:t+6e4}),!0):!(r.count>=10)&&(r.count++,!0)}(r))return i.NextResponse.json({success:!1,error:"Too many requests"},{status:429,headers:t});let{widgetId:o,pageUrl:s,referrer:n}=await e.json();if(!o||!/^[a-zA-Z0-9_-]{12}$/.test(o))return i.NextResponse.json({success:!1,error:"Invalid widget ID"},{status:400,headers:t});if(!s||!function(e){if(!e||e.length>2048)return!1;try{return new URL(e),!0}catch{return!1}}(s))return i.NextResponse.json({success:!1,error:"Invalid page URL"},{status:400,headers:t});let a=(0,u.m)(),{data:c,error:w}=await a.from("users").select("id, paid").eq("widget_id",o).maybeSingle();if(w)return console.error("[Track] Database error:",w),i.NextResponse.json({success:!1,error:"Database error"},{status:500,headers:t});if(!c)return i.NextResponse.json({success:!1,error:"Widget ID not found"},{status:404,headers:t});if(!c.paid)return i.NextResponse.json({success:!1,error:"Payment required"},{status:402,headers:t});let{allowed:y,currentCount:h}=await d(a,c.id);if(!y)return i.NextResponse.json({success:!1,error:"Monthly limit reached (10,000 pageviews)"},{status:429,headers:t});let f=await l(r),m=e.headers.get("user-agent")||null,{error:v}=await a.from("visitors").insert({user_id:c.id,country:f.country,country_code:f.countryCode,city:f.city,latitude:f.latitude,longitude:f.longitude,page_url:s,user_agent:m,referrer:n||null});if(v)return console.error("[Track] Error inserting visitor:",v),i.NextResponse.json({success:!1,error:"Failed to track visitor"},{status:500,headers:t});return await g(a,c.id),i.NextResponse.json({success:!0,message:"Tracked"},{headers:t})}catch(e){return console.error("[Track] Error:",e),i.NextResponse.json({success:!1,error:"Internal server error"},{status:500,headers:t})}}let h=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/track/route",pathname:"/api/track",filename:"route",bundlePath:"app/api/track/route"},resolvedPagePath:"/workspaces/MapMyVisitors-Cursor/app/api/track/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:v}=h,_="/api/track/route";function x(){return(0,a.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:m})}},85662:(e,t,r)=>{r.d(t,{m:()=>s});var o=r(94738);function s(){let e=process.env.NEXT_PUBLIC_SUPABASE_URL,t=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!e||!t)throw Error("Missing Supabase environment variables");return(0,o.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1}})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[948,37,70],()=>r(80807));module.exports=o})();